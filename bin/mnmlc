#!/usr/bin/env mnml

(load
  "@lib/args.l" "@lib/cc.l" "@lib/has.l" "@lib/rev.l" "@lib/split.l"
  '(io prinl)
  '(logic and =)
  '(std car cdr setq let if prog when))

(def usage ()
  "Print out a usage string for this script."
  (let ((arg0 . (car (cdr ARGV)))
        (prgn . (car (rev (split arg0 ^/)))))
    (prinl "Usage: " prgn " -c FILE.l -o FILE.c")
    (prinl)
    (prinl "  -c  Minima.l source file")
    (prinl "  -o  Target C file")
    (prinl "  -h  Print this help")
    ))

(setq options
  '(("-c" . (\ (SRC) (setq SRC SRC)))
    ("-o" . (\ (DST) (setq DST DST)))
    ("-v" . (\ () (setq VERBOSE T)))
    ("-h" . usage)))

(let ((args . (args:parse options)))
  (if (and (has args "-c") (has args "-o"))
    (let ((symb . (load SRC)))
      (if symb
        (prog
          (when VERBOSE (prinl "Transpiling '" symb " to " DST))
          (= symb (cc:compile symb DST)))
        (prog
          (prinl "Failed to load: " SRC)
          (usage))))
    (if (not (has args "-h"))
      (usage))))

# vim: ft=minimal:ts=2:sts=2:sw=2:et:tw=80
